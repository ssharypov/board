{% extends "_layout.html" %}
{% block header_scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
{% endblock header_scripts %}
{% block title %}
Разместить объявление о поиске исполнителя
{% endblock title %}

{% block content %}

<h6 class="mt-4">Шаг 1: Подпишитесь на нашего Телеграм-бота</h6>

<p>
    Подпишитесь на нашего бота Телеграм-бота, чтобы получать сообщения, если с вами захочет связаться исполнитель. <a
        href="#" class="alert-link">Ссылка на бота >></a>
</p>

<p>
    Бот отправит код авторизации, после которого вы сможете подать заявку.
</p>

<h6>Шаг 2: Максимально опишите ваши пожелания.</h6>

<form class="mt-3" method="post">
    {% csrf_token %}
    <div class="mb-3">
        {{ form.order_description }}
    </div>
    {{ form.date }}
    <h6>Шаг 3: Перейдите в бота и запросите код.</h6>
    <div class="text-center mb-5">
        <!--div class="text-center mb-5">
            <input type="text" name="validation-code" id="validation-code" class="form-control w-25 m-auto text-center"
                placeholder="Введите код">
            </textarea>
        </div-->
        {% if error %}
        <span>{{ error }}</span>
        {% endif %}
        <div id="submit_block">
            <input id="verifier" type="text" placeholder="Введит одноразовый код"
                class="form-control w-25 m-auto text-center mb-3">
            </input>
        </div>
        <span id="invalid_code" class="link-danger"></span>
    </div>
</form>

{% endblock content %}

{% block scripts %}
<script>
    $('input#verifier').on('propertychange input', function (e) {
        var valueChanged = false;
        if (e.type == 'propertychange') {
            valueChanged = e.originalEvent.propertyName == 'value';
        }
        else {
            valueChanged = true;
        }
        if (valueChanged) {
            value = $('input#verifier').val()
            if (value.length == 5) {
                document.getElementById('submit_block').innerHTML = '<div class="spinner-border ml-auto" role="status" aria-hidden="true">'
                $.ajax({
                    'type': 'POST',
                    'url': 'check_code',
                    'data': {
                        'code': value,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        resp = JSON.parse(response);
                        result = resp.result
                        if (result === "true") {
                            document.getElementById('submit_block').innerHTML = '<input id="submit" type="submit" class="btn btn-primary" value="Подать объявление"></input>'
                            document.getElementById('invalid_code').innerHTML = ""
                        } else {
                            document.getElementById('invalid_code').innerHTML = "Введенный код неверен"
                        }
                    },
                    error: function (response) {
                        result = jQuery.parseJSON(response);
                        document.getElementById('invalid_code').innerHTML = "Введенный код неверен"
                    },
                });
            }
        }
    });
</script>
{% endblock scripts %}